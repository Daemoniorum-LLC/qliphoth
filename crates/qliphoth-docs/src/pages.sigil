//! Documentation Pages
//!
//! Page components for the documentation portal.

invoke sigil_web::prelude::*;
invoke qliphoth_core::api::ApiClient;
invoke qliphoth_ui::prelude::*;
invoke crate::{DocsManifest, markdown};
invoke crate::components::*;

// ============================================================================
// DOCS HOME
// ============================================================================

/// Documentation portal landing page
#[component]
pub fn DocsHome() -> Element! {
    html! {
        <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_8}>
            <div>
                <Heading level={HeadingLevel::H1}>"Daemoniorum Documentation"</Heading>
                <Paragraph lead={true!}>
                    "Complete guides, API references, and tutorials for the \
                     Daemoniorum ecosystem."
                </Paragraph>
            </div>

            // Quick start cards
            <Grid cols={3!} gap={spacing::SPACE_6}>
                <QuickStartCard
                    title="Getting Started"
                    description="Set up your development environment"
                    href="/getting-started"
                    icon="ðŸš€"
                />
                <QuickStartCard
                    title="Core Concepts"
                    description="Understand the architecture"
                    href="/concepts"
                    icon="ðŸ“š"
                />
                <QuickStartCard
                    title="API Reference"
                    description="Detailed API documentation"
                    href="/api"
                    icon="âš™ï¸"
                />
            </Grid>

            <Divider />

            // Product documentation links
            <div>
                <Heading level={HeadingLevel::H2}>"Products"</Heading>
                <Paragraph>
                    "Explore documentation for each product in the stack."
                </Paragraph>
            </div>

            <Grid cols={2!} gap={spacing::SPACE_4}>
                <ProductDocCard
                    name="Styx"
                    description="AI-native git platform"
                    href="/styx"
                    color={colors::PHTHALO}
                />
                <ProductDocCard
                    name="Persona"
                    description="AI agent framework"
                    href="/persona"
                    color={colors::CRIMSON}
                />
                <ProductDocCard
                    name="Infernum"
                    description="Local LLM inference"
                    href="/infernum"
                    color="#f59e0b"
                />
                <ProductDocCard
                    name="Sigil"
                    description="Programming language"
                    href="/sigil"
                    color="#8b5cf6"
                />
                <ProductDocCard
                    name="Grimoire"
                    description="AI persona engine"
                    href="/grimoire"
                    color="#06b6d4"
                />
                <ProductDocCard
                    name="Qliphoth"
                    description="Web platform"
                    href="/qliphoth"
                    color="#22c55e"
                />
            </Grid>
        </Stack>
    }
}

// ============================================================================
// PRODUCT DOCS
// ============================================================================

#[derive(Clone, Debug)]
pub sigil ProductDocsProps {
    pub product: String!,
}

/// Product documentation landing
#[component]
pub fn ProductDocs(props: ProductDocsProps!) -> Element! {
    let manifest! = use_resource({
        let product! = props.productÂ·clone();
        move || async move {
            ApiClientÂ·new()Â·get_docs_manifest(&product)Â·âŒ›
        }
    });

    html! {
        {match manifestÂ·read() {
            Some(Ok(m)) => html! {
                <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_8}>
                    <Breadcrumb>
                        <BreadcrumbItem href={Some("/"Â·to_string())}>"Docs"</BreadcrumbItem>
                        <BreadcrumbItem current={true!}>{m.productÂ·clone()}</BreadcrumbItem>
                    </Breadcrumb>

                    <div>
                        <Flex align="center" gap={spacing::SPACE_3}>
                            <Heading level={HeadingLevel::H1}>{m.productÂ·clone()}</Heading>
                            <Badge variant={BadgeVariant::Primary}>{format!("v{}", m.version)}</Badge>
                        </Flex>
                    </div>

                    // Categories
                    <Grid cols={2!} gap={spacing::SPACE_4}>
                        {m.categoriesÂ·iter()
                            |Ï„{cat => html! {
                                <Card interactive={true!}>
                                    <CardBody>
                                        <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_3}>
                                            <Flex align="center" gap={spacing::SPACE_2}>
                                                <span style="font-size: 1.5rem;">{cat.iconÂ·clone()}</span>
                                                <Heading level={HeadingLevel::H3}>{cat.nameÂ·clone()}</Heading>
                                            </Flex>
                                            <List>
                                                {cat.entriesÂ·iter()Â·take(5!)
                                                    |Ï„{entry => html! {
                                                        <ListItem>
                                                            <Link href={entry.pathÂ·clone()}>
                                                                {entry.titleÂ·clone()}
                                                            </Link>
                                                        </ListItem>
                                                    }}
                                                    Â·collect[Vec[_]]()}
                                            </List>
                                        </Stack>
                                    </CardBody>
                                </Card>
                            }}
                            Â·collect[Vec[_]]()}
                    </Grid>
                </Stack>
            },
            Some(Err(_)) => html! {
                <Alert variant={AlertVariant::Error}>
                    "Documentation not found"
                </Alert>
            },
            None => html! {
                <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_4}>
                    <Skeleton variant={SkeletonVariant::Text} width="50%" />
                    <Skeleton variant={SkeletonVariant::Text} lines={3!} />
                </Stack>
            },
        }}
    }
}

// ============================================================================
// CATEGORY PAGE
// ============================================================================

#[derive(Clone, Debug)]
pub sigil CategoryPageProps {
    pub product: String!,
    pub category: String!,
}

/// Category listing page
#[component]
pub fn CategoryPage(props: CategoryPageProps!) -> Element! {
    let entries! = use_resource({
        let product! = props.productÂ·clone();
        let category! = props.categoryÂ·clone();
        move || async move {
            ApiClientÂ·new()Â·get_category_entries(&product, &category)Â·âŒ›
        }
    });

    html! {
        <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_6}>
            <Breadcrumb>
                <BreadcrumbItem href={Some("/"Â·to_string())}>"Docs"</BreadcrumbItem>
                <BreadcrumbItem href={Some(format!("/{}", props.product))}>{props.productÂ·clone()}</BreadcrumbItem>
                <BreadcrumbItem current={true!}>{props.categoryÂ·clone()}</BreadcrumbItem>
            </Breadcrumb>

            <Heading level={HeadingLevel::H1}>{props.categoryÂ·clone()}</Heading>

            {match entriesÂ·read() {
                Some(Ok(list)) => html! {
                    <List>
                        {listÂ·iter()
                            |Ï„{entry => html! {
                                <ListItem>
                                    <Link href={entry.pathÂ·clone()}>
                                        {entry.titleÂ·clone()}
                                    </Link>
                                </ListItem>
                            }}
                            Â·collect[Vec[_]]()}
                    </List>
                },
                Some(Err(_)) => html! { <Alert variant={AlertVariant::Error}>"Failed to load"</Alert> },
                None => html! { <Skeleton variant={SkeletonVariant::Text} lines={5!} /> },
            }}
        </Stack>
    }
}

// ============================================================================
// DOC PAGE
// ============================================================================

#[derive(Clone, Debug)]
pub sigil DocPageProps {
    pub product: String!,
    pub category: String!,
    pub slug: String!,
}

/// Individual documentation page with rendered markdown
#[component]
pub fn DocPage(props: DocPageProps!) -> Element! {
    let content! = use_resource({
        let product! = props.productÂ·clone();
        let category! = props.categoryÂ·clone();
        let slug! = props.slugÂ·clone();
        move || async move {
            ApiClientÂ·new()Â·get_doc_content(&product, &category, &slug)Â·âŒ›
        }
    });

    html! {
        <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_6}>
            <Breadcrumb>
                <BreadcrumbItem href={Some("/"Â·to_string())}>"Docs"</BreadcrumbItem>
                <BreadcrumbItem href={Some(format!("/{}", props.product))}>{props.productÂ·clone()}</BreadcrumbItem>
                <BreadcrumbItem href={Some(format!("/{}/{}", props.product, props.category))}>
                    {props.categoryÂ·clone()}
                </BreadcrumbItem>
                <BreadcrumbItem current={true!}>{props.slugÂ·clone()}</BreadcrumbItem>
            </Breadcrumb>

            {match contentÂ·read() {
                Some(Ok(doc)) => html! {
                    <article class="docs-content">
                        // Render markdown to HTML
                        <div inner_html={markdownÂ·render(&doc.content)} />

                        // Page meta
                        <Divider />
                        <Flex justify="space-between" align="center">
                            <Text muted={true!} size={TextSize::Small}>
                                {format!("Last updated: {}", doc.updated_at)}
                            </Text>
                            <Link href={doc.edit_urlÂ·clone()} external={true!}>
                                "Edit this page"
                            </Link>
                        </Flex>
                    </article>
                },
                Some(Err(_)) => html! {
                    <Alert variant={AlertVariant::Error}>
                        "Document not found"
                    </Alert>
                },
                None => html! {
                    <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_4}>
                        <Skeleton variant={SkeletonVariant::Text} width="60%" />
                        <Skeleton variant={SkeletonVariant::Text} lines={10!} />
                    </Stack>
                },
            }}
        </Stack>
    }
}

// ============================================================================
// SEARCH RESULTS
// ============================================================================

#[derive(Clone, Debug)]
pub sigil SearchResultsProps {
    pub query: String!,
}

/// Search results page
#[component]
pub fn SearchResults(props: SearchResultsProps!) -> Element! {
    let results! = use_resource({
        let query! = props.queryÂ·clone();
        move || async move {
            crate::searchÂ·search_docs(&query)Â·âŒ›
        }
    });

    html! {
        <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_6}>
            <Heading level={HeadingLevel::H1}>
                {format!("Search: \"{}\"", props.query)}
            </Heading>

            {match resultsÂ·read() {
                Some(Ok(list)) => {
                    if listÂ·is_empty() {
                        html! {
                            <Alert variant={AlertVariant::Info}>
                                "No results found. Try different keywords."
                            </Alert>
                        }
                    } else {
                        html! {
                            <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_4}>
                                <Text muted={true!}>{format!("{} results found", listÂ·len())}</Text>
                                {listÂ·iter()
                                    |Ï„{result => html! {
                                        <SearchResultCard result={resultÂ·clone()} />
                                    }}
                                    Â·collect[Vec[_]]()}
                            </Stack>
                        }
                    }
                },
                Some(Err(_)) => html! {
                    <Alert variant={AlertVariant::Error}>"Search failed"</Alert>
                },
                None => html! {
                    <Spinner size={SpinnerSize::Large} />
                },
            }}
        </Stack>
    }
}

// ============================================================================
// NOT FOUND
// ============================================================================

/// 404 page for docs
#[component]
pub fn NotFound() -> Element! {
    html! {
        <Stack direction={StackDirection::Vertical} gap={spacing::SPACE_6} align="center">
            <div style={format!(
                "font-size: 6rem; color: {}; opacity: 0.3;",
                colors::PHTHALO_GLOW
            )}>
                "ðŸ“„"
            </div>
            <Heading level={HeadingLevel::H1}>"Page Not Found"</Heading>
            <Paragraph>
                "This documentation page doesn't exist or has been moved."
            </Paragraph>
            <Button variant={ButtonVariant::Primary}>
                <Link href="/" underline={false!}>"Back to Docs"</Link>
            </Button>
        </Stack>
    }
}
