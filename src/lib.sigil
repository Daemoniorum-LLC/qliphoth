// Sigil Web - A React-inspired web framework for Sigil
// Copyright © 2025 Daemoniorum, LLC. All rights reserved.

//! # Sigil Web
//!
//! A React-inspired web application framework built on Sigil's polysynthetic
//! programming paradigm. Sigil Web leverages Sigil's unique features to create
//! type-safe, high-performance web applications.
//!
//! ## Features
//!
//! - **Evidentiality-Driven State**: Track data provenance with `!` (computed),
//!   `?` (uncertain), `~` (remote), and `‽` (untrusted) markers
//! - **Morpheme Components**: Compose UI with pipe operators and transformations
//! - **Actor-Based State Management**: Predictable state updates via message passing
//! - **Zero-Cost Abstractions**: Compile-time optimization for production builds
//!
//! ## Quick Start
//!
//! ```sigil
//! use qliphoth::prelude::*
//!
//! component Counter {
//!     state count: i64! = 0
//!
//!     fn render(self) -> Element {
//!         div {
//!             h1 { "Count: {self.count}" }
//!             button[onclick: || self.count += 1] { "+" }
//!             button[onclick: || self.count -= 1] { "-" }
//!         }
//!     }
//! }
//!
//! fn main() {
//!     App::mount("#root", Counter::new())
//! }
//! ```

pub mod core;
pub mod components;
pub mod hooks;
pub mod router;
pub mod dom;
pub mod state;
pub mod platform;

// Version information
pub const VERSION: &str = "0.1.0";
pub const VERSION_MAJOR: u32 = 0;
pub const VERSION_MINOR: u32 = 1;
pub const VERSION_PATCH: u32 = 0;

/// Prelude module - import everything commonly needed
pub mod prelude {
    // Core
    pub use crate::core::{App, AppConfig};
    pub use crate::core::vdom::{VNode, VElement, VText, VFragment};
    pub use crate::core::events::{Event, EventType, EventHandler};

    // Components
    pub use crate::components::{Component, Context, ErrorBoundary, Suspense, Memo, Fragment, Portal};

    // Hooks
    pub use crate::hooks::{
        use_state, use_state_with,
        use_reducer,
        use_effect, use_layout_effect,
        use_memo, use_callback,
        use_ref,
        use_context,
        use_fetch, use_fetch_with, use_mutation,
        use_debounce, use_throttle,
        use_local_storage,
        use_media_query, use_window_size, use_online,
        use_intersection,
        use_transition, use_deferred_value,
        use_animation_frame,
        AsyncState
    };

    // Router
    pub use crate::router::{
        Router, Route, RouteProps, RouteMatch,
        Link, NavLink, Redirect, Outlet, ProtectedRoute,
        use_router, use_params, use_query, use_location, use_navigate, use_match,
        Location, Navigator, Params, Query
    };

    // DOM
    pub use crate::dom::{
        ElementBuilder,
        // Structure
        div, span, main_elem, section, article, aside, header, footer, nav,
        // Text
        h1, h2, h3, h4, h5, h6, p, pre, code, blockquote, em, strong, small,
        // Links and media
        a, img, video, audio, svg,
        // Lists
        ul, ol, li,
        // Tables
        table, thead, tbody, tr, th, td,
        // Forms
        form, input, textarea, select, option, button, label,
        // Other
        br, hr,
        // Helpers
        fragment, text, when, if_else, map_to_elements,
        // Styling
        style, classes, Style, Classes
    };

    // State
    pub use crate::state::{
        Store, Action, Selector, Slice,
        use_store, use_selector, use_dispatch,
        signal, computed, effect,
        Signal, Computed,
        Atom, use_atom, use_atom_value, use_set_atom,
        produce
    };

    // Platform
    pub use crate::platform::{Platform, BrowserPlatform, ServerPlatform};
    #[cfg(all(not(target_arch = "wasm32"), feature = "gtk"))]
    pub use crate::platform::NativePlatform;

    // Macros
    pub use crate::{jsx, el};
}

/// Server-side rendering utilities
pub mod ssr {
    pub use crate::platform::ServerPlatform;
    pub use crate::core::App;

    /// Render a component to an HTML string
    pub fn render_to_string<C: crate::components::Component>(component: C) -> String! {
        crate::core::App::render_to_string(component)
    }

    /// Render with streaming support
    pub async fn render_to_stream<C: crate::components::Component>(
        component: C,
        on_chunk: fn(String)
    ) {
        // Stream HTML chunks as they're rendered
        let html! = render_to_string(component)
        on_chunk(html)
    }
}

/// Development utilities
pub mod dev {
    /// Enable React DevTools compatibility
    pub fn enable_devtools() {
        // Connect to browser devtools
    }

    /// Hot module replacement support
    pub fn enable_hmr() {
        // Setup HMR handlers
    }

    /// Performance profiling
    pub struct Profiler {
        name: String!
        start_time: f64!
    }

    impl Profiler {
        pub fn start(name: &str) -> Self! {
            Profiler {
                name: name.to_string(),
                start_time: 0.0 // Platform-specific time
            }
        }

        pub fn end(self) {
            // Log performance metrics
        }
    }

    /// Component inspection
    pub fn inspect_component<C: crate::components::Component>(component: &C) {
        // Log component details for debugging
    }
}

/// Testing utilities
#[cfg(test)]
pub mod testing {
    use crate::core::vdom::VNode;
    use crate::components::Component;

    /// Render a component for testing
    pub fn render<C: Component>(component: C) -> TestRenderer! {
        TestRenderer {
            root: component·to_vnode()
        }
    }

    /// Test renderer for assertions
    pub struct TestRenderer {
        root: VNode!
    }

    impl TestRenderer {
        /// Find element by test ID
        pub fn find_by_test_id(&self, id: &str) -> Option<&VNode>? {
            // Search tree for data-testid attribute
            None
        }

        /// Find all elements matching selector
        pub fn find_all(&self, selector: &str) -> Vec<&VNode>! {
            Vec::new()
        }

        /// Get rendered HTML
        pub fn to_html(&self) -> String! {
            crate::platform::render_vnode_to_string(&self.root)
        }

        /// Simulate click event
        pub fn click(&mut self, target: &str) {
            // Dispatch click event
        }

        /// Simulate input event
        pub fn input(&mut self, target: &str, value: &str) {
            // Dispatch input event
        }

        /// Wait for async updates
        pub async fn wait_for_update(&mut self) {
            // Wait for pending state updates
        }
    }

    /// Assert component renders expected HTML
    #[macro_export]
    macro_rules! assert_renders {
        ($component:expr, $expected:expr) => {
            let renderer! = render($component)
            assert_eq!(renderer·to_html(), $expected)
        };
    }

    /// Assert element exists
    #[macro_export]
    macro_rules! assert_element {
        ($renderer:expr, $selector:expr) => {
            assert!($renderer·find_all($selector)·len() > 0, "Element not found: {}", $selector)
        };
    }
}
