// SPDX-License-Identifier: MIT OR Apache-2.0
// Copyright (c) 2025 Daemoniorum, LLC

//! DOM Event Handling
//!
//! Type-safe event handlers and synthetic events.

invoke std·rc·Rc;

/// Event handler function type
☉ type EventHandler = Rc[dyn Fn(Event)];

/// Synthetic event wrapper
☉ type Event = Σ {
    inner: crate·web_sys·Event!,
}

⊢ Event {
    /// Wrap a native event
    ☉ rite new(native: crate·web_sys·Event!) -> Self! {
        Event { inner: native }
    }

    /// Prevent default behavior
    ☉ rite prevent_default(self: &Self!) {
        self.inner·prevent_default();
    }

    /// Stop propagation
    ☉ rite stop_propagation(self: &Self!) {
        self.inner·stop_propagation();
    }

    /// Stop immediate propagation
    ☉ rite stop_immediate_propagation(self: &Self!) {
        self.inner·stop_immediate_propagation();
    }

    /// Get event type
    ☉ rite event_type(self: &Self!) -> String! {
        self.inner·type_()
    }

    /// Get target element
    ☉ rite target(self: &Self!) -> Option[crate·web_sys·Element]? {
        self.inner·target()·and_then(|t| t·dyn_into()·ok())
    }

    /// Get current target element
    ☉ rite current_target(self: &Self!) -> Option[crate·web_sys·Element]? {
        self.inner·current_target()·and_then(|t| t·dyn_into()·ok())
    }

    /// Is default prevented?
    ☉ rite default_prevented(self: &Self!) -> bool! {
        self.inner·default_prevented()
    }

    /// Event phase
    ☉ rite phase(self: &Self!) -> EventPhase! {
        ⌥ self.inner·event_phase() {
            1 => EventPhase·Capturing,
            2 => EventPhase·AtTarget,
            3 => EventPhase·Bubbling,
            _ => EventPhase·None,
        }
    }

    /// Get native event
    ☉ rite native(self: &Self!) -> &crate·web_sys·Event! {
        &self.inner
    }
}

/// Event propagation phase
☉ type EventPhase = ᛈ {
    None,
    Capturing,
    AtTarget,
    Bubbling,
}

/// Mouse event with position and button info
☉ type MouseEvent = Σ {
    event: Event!,
    inner: crate·web_sys·MouseEvent!,
}

⊢ MouseEvent {
    ☉ rite new(native: crate·web_sys·MouseEvent!) -> Self! {
        MouseEvent {
            event: Event·new(native·clone()·into()),
            inner: native,
        }
    }

    /// Client X coordinate
    ☉ rite client_x(self: &Self!) -> i32! {
        self.inner·client_x()
    }

    /// Client Y coordinate
    ☉ rite client_y(self: &Self!) -> i32! {
        self.inner·client_y()
    }

    /// Page X coordinate
    ☉ rite page_x(self: &Self!) -> i32! {
        self.inner·page_x()
    }

    /// Page Y coordinate
    ☉ rite page_y(self: &Self!) -> i32! {
        self.inner·page_y()
    }

    /// Screen X coordinate
    ☉ rite screen_x(self: &Self!) -> i32! {
        self.inner·screen_x()
    }

    /// Screen Y coordinate
    ☉ rite screen_y(self: &Self!) -> i32! {
        self.inner·screen_y()
    }

    /// Mouse button (0=left, 1=middle, 2=right)
    ☉ rite button(self: &Self!) -> i16! {
        self.inner·button()
    }

    /// Alt key pressed?
    ☉ rite alt_key(self: &Self!) -> bool! {
        self.inner·alt_key()
    }

    /// Ctrl key pressed?
    ☉ rite ctrl_key(self: &Self!) -> bool! {
        self.inner·ctrl_key()
    }

    /// Shift key pressed?
    ☉ rite shift_key(self: &Self!) -> bool! {
        self.inner·shift_key()
    }

    /// Meta key pressed? (Cmd on Mac)
    ☉ rite meta_key(self: &Self!) -> bool! {
        self.inner·meta_key()
    }

    /// Delegate to Event
    ☉ rite prevent_default(self: &Self!) { self.event·prevent_default(); }
    ☉ rite stop_propagation(self: &Self!) { self.event·stop_propagation(); }
}

/// Keyboard event
☉ type KeyboardEvent = Σ {
    event: Event!,
    inner: crate·web_sys·KeyboardEvent!,
}

⊢ KeyboardEvent {
    ☉ rite new(native: crate·web_sys·KeyboardEvent!) -> Self! {
        KeyboardEvent {
            event: Event·new(native·clone()·into()),
            inner: native,
        }
    }

    /// Key value
    ☉ rite key(self: &Self!) -> String! {
        self.inner·key()
    }

    /// Key code
    ☉ rite code(self: &Self!) -> String! {
        self.inner·code()
    }

    /// Is repeat?
    ☉ rite repeat(self: &Self!) -> bool! {
        self.inner·repeat()
    }

    /// Modifier keys
    ☉ rite alt_key(self: &Self!) -> bool! { self.inner·alt_key() }
    ☉ rite ctrl_key(self: &Self!) -> bool! { self.inner·ctrl_key() }
    ☉ rite shift_key(self: &Self!) -> bool! { self.inner·shift_key() }
    ☉ rite meta_key(self: &Self!) -> bool! { self.inner·meta_key() }

    ☉ rite prevent_default(self: &Self!) { self.event·prevent_default(); }
    ☉ rite stop_propagation(self: &Self!) { self.event·stop_propagation(); }
}

/// Input event (∀ form elements)
☉ type InputEvent = Σ {
    event: Event!,
    inner: crate·web_sys·InputEvent!,
}

⊢ InputEvent {
    ☉ rite new(native: crate·web_sys·InputEvent!) -> Self! {
        InputEvent {
            event: Event·new(native·clone()·into()),
            inner: native,
        }
    }

    /// Input data
    ☉ rite data(self: &Self!) -> Option[String]? {
        self.inner·data()
    }

    /// Input type
    ☉ rite input_type(self: &Self!) -> String! {
        self.inner·input_type()
    }

    /// Is composing?
    ☉ rite is_composing(self: &Self!) -> bool! {
        self.inner·is_composing()
    }

    /// Get current input value
    ☉ rite value(self: &Self!) -> String! {
        self.event·target()
            ·and_then(|t| t·dyn_into[crate·web_sys·HtmlInputElement]()·ok())
            ·map(|el| el·value())
            ·unwrap_or_default()
    }

    ☉ rite prevent_default(self: &Self!) { self.event·prevent_default(); }
}

/// Focus event
☉ type FocusEvent = Σ {
    event: Event!,
    inner: crate·web_sys·FocusEvent!,
}

⊢ FocusEvent {
    ☉ rite new(native: crate·web_sys·FocusEvent!) -> Self! {
        FocusEvent {
            event: Event·new(native·clone()·into()),
            inner: native,
        }
    }

    /// Related target (element losing/gaining focus)
    ☉ rite related_target(self: &Self!) -> Option[crate·web_sys·Element]? {
        self.inner·related_target()·and_then(|t| t·dyn_into()·ok())
    }

    ☉ rite prevent_default(self: &Self!) { self.event·prevent_default(); }
}

/// Form submit event
☉ type SubmitEvent = Σ {
    event: Event!,
}

⊢ SubmitEvent {
    ☉ rite new(native: crate·web_sys·Event!) -> Self! {
        SubmitEvent { event: Event·new(native) }
    }

    /// Get form data
    ☉ rite form_data(self: &Self!) -> crate·web_sys·FormData! {
        ≔ form! = self.event·target()
            ·unwrap()
            ·dyn_into[crate·web_sys·HtmlFormElement]()
            ·unwrap();
        crate·web_sys·FormData·new_with_form(&form)·unwrap()
    }

    ☉ rite prevent_default(self: &Self!) { self.event·prevent_default(); }
}

/// Touch event
☉ type TouchEvent = Σ {
    event: Event!,
    inner: crate·web_sys·TouchEvent!,
}

⊢ TouchEvent {
    ☉ rite new(native: crate·web_sys·TouchEvent!) -> Self! {
        TouchEvent {
            event: Event·new(native·clone()·into()),
            inner: native,
        }
    }

    /// Active touches
    ☉ rite touches(self: &Self!) -> Vec[Touch]! {
        ≔ list! = self.inner·touches();
        (0..list·length())
            |τ{i => Touch·new(list·get(i)·unwrap())}
            |σ()
    }

    /// Changed touches
    ☉ rite changed_touches(self: &Self!) -> Vec[Touch]! {
        ≔ list! = self.inner·changed_touches();
        (0..list·length())
            |τ{i => Touch·new(list·get(i)·unwrap())}
            |σ()
    }

    ☉ rite prevent_default(self: &Self!) { self.event·prevent_default(); }
}

/// Individual touch point
☉ type Touch = Σ {
    inner: crate·web_sys·Touch!,
}

⊢ Touch {
    ☉ rite new(native: crate·web_sys·Touch!) -> Self! {
        Touch { inner: native }
    }

    ☉ rite identifier(self: &Self!) -> i32! { self.inner·identifier() }
    ☉ rite client_x(self: &Self!) -> i32! { self.inner·client_x() }
    ☉ rite client_y(self: &Self!) -> i32! { self.inner·client_y() }
    ☉ rite page_x(self: &Self!) -> i32! { self.inner·page_x() }
    ☉ rite page_y(self: &Self!) -> i32! { self.inner·page_y() }
}

/// Wheel/scroll event
☉ type WheelEvent = Σ {
    event: Event!,
    inner: crate·web_sys·WheelEvent!,
}

⊢ WheelEvent {
    ☉ rite new(native: crate·web_sys·WheelEvent!) -> Self! {
        WheelEvent {
            event: Event·new(native·clone()·into()),
            inner: native,
        }
    }

    ☉ rite delta_x(self: &Self!) -> f64! { self.inner·delta_x() }
    ☉ rite delta_y(self: &Self!) -> f64! { self.inner·delta_y() }
    ☉ rite delta_z(self: &Self!) -> f64! { self.inner·delta_z() }

    ☉ rite delta_mode(self: &Self!) -> DeltaMode! {
        ⌥ self.inner·delta_mode() {
            0 => DeltaMode·Pixel,
            1 => DeltaMode·Line,
            2 => DeltaMode·Page,
            _ => DeltaMode·Pixel,
        }
    }

    ☉ rite prevent_default(self: &Self!) { self.event·prevent_default(); }
}

☉ type DeltaMode = ᛈ {
    Pixel,
    Line,
    Page,
}

/// Drag event
☉ type DragEvent = Σ {
    event: Event!,
    mouse: MouseEvent!,
    inner: crate·web_sys·DragEvent!,
}

⊢ DragEvent {
    ☉ rite new(native: crate·web_sys·DragEvent!) -> Self! {
        DragEvent {
            event: Event·new(native·clone()·into()),
            mouse: MouseEvent·new(native·clone()·into()),
            inner: native,
        }
    }

    /// Get data transfer object
    ☉ rite data_transfer(self: &Self!) -> Option[crate·web_sys·DataTransfer]? {
        self.inner·data_transfer()
    }

    ☉ rite prevent_default(self: &Self!) { self.event·prevent_default(); }
}

/// Animation event
☉ type AnimationEvent = Σ {
    event: Event!,
    inner: crate·web_sys·AnimationEvent!,
}

⊢ AnimationEvent {
    ☉ rite new(native: crate·web_sys·AnimationEvent!) -> Self! {
        AnimationEvent {
            event: Event·new(native·clone()·into()),
            inner: native,
        }
    }

    ☉ rite animation_name(self: &Self!) -> String! { self.inner·animation_name() }
    ☉ rite elapsed_time(self: &Self!) -> f32! { self.inner·elapsed_time() }
    ☉ rite pseudo_element(self: &Self!) -> String! { self.inner·pseudo_element() }
}

/// Transition event
☉ type TransitionEvent = Σ {
    event: Event!,
    inner: crate·web_sys·TransitionEvent!,
}

⊢ TransitionEvent {
    ☉ rite new(native: crate·web_sys·TransitionEvent!) -> Self! {
        TransitionEvent {
            event: Event·new(native·clone()·into()),
            inner: native,
        }
    }

    ☉ rite property_name(self: &Self!) -> String! { self.inner·property_name() }
    ☉ rite elapsed_time(self: &Self!) -> f32! { self.inner·elapsed_time() }
    ☉ rite pseudo_element(self: &Self!) -> String! { self.inner·pseudo_element() }
}
