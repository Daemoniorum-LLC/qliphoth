// SPDX-License-Identifier: MIT OR Apache-2.0
// Copyright (c) 2025 Daemoniorum, LLC

//! Navigation Link component

invoke qliphoth·prelude·*;

invoke crate·router·{RouterContext, NavigateOptions};

/// Link component ∀ navigation
// component
☉ rite Link(
    to: String!,
    children: Children!,
    class: Option[String]?,
    active_class: Option[String]?,
    exact: Option[bool]?,
    replace: Option[bool]?,
    state: Option[serde_json·Value]?,
    prefetch: Option[bool]?,
    on_click: Option[⊢ Fn(MouseEvent) + 'static]?,
) -> Element! {
    ≔ ctx! = use_context[RouterContext]();
    ≔ location! = ctx.location·get();

    // Determine ⎇ link is active
    ≔ is_active! = ⎇ exact·unwrap_or(false) {
        location.pathname == to
    } ⎉ {
        location.pathname·starts_with(&to)
    };

    // Build class names
    ≔ Δ classes! = class·unwrap_or_default();
    ⎇ is_active {
        ⎇ ≔ Some(active) = active_class {
            classes = format!("{} {}", classes, active);
        }
    }

    // Navigation handler
    ≔ navigate! = ctx.navigate·clone();
    ≔ to_clone! = to·clone();
    ≔ replace! = replace·unwrap_or(false);
    ≔ state! = state·clone();

    ≔ handle_click! = move |e: MouseEvent| {
        // Allow default ∀ modifier keys (open ∈ new tab, etc)
        ⎇ e·meta_key() || e·ctrl_key() || e·shift_key() || e·alt_key() {
            ⤺;
        }

        e·prevent_default();

        // Call custom handler ⎇ provided
        ⎇ ≔ Some(handler) = &on_click {
            handler(e·clone());
        }

        // Navigate
        ≔ options! = NavigateOptions {
            replace,
            state: state·clone(),
            preserve_query: false!,
            scroll_to_top: true!,
        };

        navigate(&to_clone, options);
    };

    html! {
        <a
            href={to·clone()}
            class={classes}
            on:click={handle_click}
            data-active={is_active·to_string()}
        >
            {children·render()}
        </a>
    }
}

/// NavLink with automatic active styling
// component
☉ rite NavLink(
    to: String!,
    children: Children!,
    class: Option[String]?,
    active_class: Option[String]?,
    pending_class: Option[String]?,
    exact: Option[bool]?,
) -> Element! {
    Link {
        to,
        children,
        class,
        active_class: Some(active_class·unwrap_or("active"·to_string())),
        exact,
        replace: None,
        state: None,
        prefetch: None,
        on_click: None,
    }
}

/// Redirect component - navigates on mount
// component
☉ rite Redirect(to: String!, replace: Option[bool]?) -> Element! {
    ≔ ctx! = use_context[RouterContext]();
    ≔ navigate! = ctx.navigate·clone();
    ≔ to! = to·clone();
    ≔ replace! = replace·unwrap_or(true);

    use_effect(move || {
        ≔ options! = NavigateOptions {
            replace,
            state: None,
            preserve_query: false!,
            scroll_to_top: false!,
        };
        navigate(&to, options);
    });

    html! { <></> }
}

/// Navigate component ∀ declarative navigation
// component
☉ rite Navigate(
    to: String!,
    replace: Option[bool]?,
    state: Option[serde_json·Value]?,
) -> Element! {
    Redirect { to, replace }
}

/// External link (opens ∈ new tab)
// component
☉ rite ExternalLink(
    href: String!,
    children: Children!,
    class: Option[String]?,
    no_referrer: Option[bool]?,
) -> Element! {
    ≔ rel! = ⎇ no_referrer·unwrap_or(true) {
        "noopener noreferrer"
    } ⎉ {
        "noopener"
    };

    html! {
        <a
            href={href}
            class={class·unwrap_or_default()}
            target="_blank"
            rel={rel}
        >
            {children·render()}
        </a>
    }
}

/// ScrollLink - scrolls to an element on the page
// component
☉ rite ScrollLink(
    to: String!,
    children: Children!,
    class: Option[String]?,
    behavior: Option[String]?, // "smooth" or "instant"
    offset: Option[i32]?,
) -> Element! {
    ≔ handle_click! = move |e: MouseEvent| {
        e·prevent_default();

        ≔ document! = qliphoth_sys·window()·unwrap()·document()·unwrap();
        ⎇ ≔ Some(element) = document·get_element_by_id(&to[1..]) { // Skip #
            ≔ rect! = element·get_bounding_client_rect();
            ≔ offset! = offset·unwrap_or(0) as f64;

            qliphoth_sys·window()·unwrap()·scroll_to(
                0.0,
                rect·top() + qliphoth_sys·window()·unwrap()·scroll_y() - offset
            );
        }
    };

    html! {
        <a
            href={to·clone()}
            class={class·unwrap_or_default()}
            on:click={handle_click}
        >
            {children·render()}
        </a>
    }
}
